<!--
A) ä»•æ§˜ã®è¦ç´„ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæ‹¡å……ç‰ˆï¼‰
- ç”»é¢ã¯ä¸Šä¸‹ 2 åˆ†å‰²ã€‚
  - ä¸Šï¼š3ã€œ6å€‹ã®æ•°å­—ãƒœã‚¿ãƒ³ï¼ˆ0ã€œ9ï¼‰ã‚’ã€Œé‡ãªã‚‰ãªã„ã‚ˆã†ã«ã€ãƒ©ãƒ³ãƒ€ãƒ é…ç½®ã€‚
  - ä¸‹ï¼šã‚¹ã‚¿ãƒ¼ãƒˆï¼ãƒªãƒˆãƒ©ã‚¤ãƒœã‚¿ãƒ³ï¼‹éŠã³æ–¹èª¬æ˜ï¼‹ãƒ™ã‚¹ãƒˆè¨˜éŒ²è¡¨ç¤ºã€‚
- ã‚¹ã‚¿ãƒ¼ãƒˆæŠ¼ä¸‹ â†’ 3 ç§’ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ â†’ 10 å•é€£ç¶šå‡ºé¡Œã€‚
- å„å•ã§ 3ã€œ6 å€‹ã®æ•°å­—ãƒœã‚¿ãƒ³ãŒãƒ©ãƒ³ãƒ€ãƒ ä½ç½®ã«å‡ºç¾ã€‚
- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã€Œæœ€å¤§ã®æ•°å­—ã€ã®ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠã€‚
- æ­£è§£æ™‚ã¯ç·‘è‰²ã€ä¸æ­£è§£æ™‚ã¯èµ¤è‰²ã«ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼‹åŠ¹æœéŸ³ã€‚
- 10 å•çµ‚äº†å¾Œã€æ­£ç­”æ•°ã¨åˆè¨ˆå›ç­”æ™‚é–“ã‚’è¡¨ç¤ºã€‚
- ãƒ™ã‚¹ãƒˆè¨˜éŒ²ï¼ˆæ­£ç­”æ•°å„ªå…ˆã€åŒç‚¹ãªã‚‰æ™‚é–“ã§æ¯”è¼ƒï¼‰ã‚’ localStorage ã«ä¿å­˜ã€‚
- iPhone / iPad å¯¾å¿œï¼ˆviewportã€Pointer Eventsã€åˆå›ã‚¿ãƒƒãƒ—ã§ WebAudio è§£éŒ ï¼‰ã€‚
- 1 ãƒ•ã‚¡ã‚¤ãƒ«å®Œçµã€‚å¤–éƒ¨ CDN ä¸ä½¿ç”¨ã€‚GitHub Pages é…å‚™å¯ã€‚
- ãƒ‡ã‚¶ã‚¤ãƒ³ã¯ä»–ã®ã‚²ãƒ¼ãƒ ï¼ˆhow_many_bolls.html, which_is_more.htmlï¼‰ã¨çµ±ä¸€ã€‚
-->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>æœ€å¤§ã®æ•°å­—ã‚’ã‚¿ãƒƒãƒ—ï¼</title>
  <style>
    /* =========================
       é…è‰²ã‚„å½±ã®ãƒˆãƒ¼ã‚¯ãƒ³
       ========================= */
    :root {
      --bg: #0f1220;
      --panel: #171a2a;
      --panel2: #0c1020;
      --text: #e8ecf1;
      --muted: #99a3b3;
      --accent: #5cc8ff;  /* ä¸»è¦ãƒœã‚¿ãƒ³è‰² */
      --ok: #4cd964;      /* æ­£è§£è‰² */
      --ng: #ff3b30;      /* ä¸æ­£è§£è‰² */
      --btn: #22263a;
      --btnActive: #2f3552;
      --shadow: 0 8px 24px rgba(0,0,0,.35);
    }

    /* ã‚¿ãƒƒãƒ—æ™‚ã®é’ã„ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ç„¡åŠ¹åŒ– */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; }

    /* ç”»é¢å…¨ä½“ã®èƒŒæ™¯ã¨åŸºæœ¬ãƒ•ã‚©ãƒ³ãƒˆ */
    body {
      margin: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      background: radial-gradient(100% 100% at 0% 0%, #0e142a, #0a0d1a 60%), var(--bg);
      color: var(--text);
      font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      height: 100svh;      /* iOS ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å¤‰å‹•å¯¾ç­– */
      overflow: hidden;     /* èƒŒæ™¯ã®ã¯ã¿å‡ºã—é˜²æ­¢ */
      touch-action: manipulation; /* ã‚¿ãƒƒãƒé…å»¶ã®å›é¿ */
    }

    /* ã‚¢ãƒ—ãƒªã®ä¸Šä¸‹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .app {
      height: 100%;
      display: flex;
      flex-direction: column; /* ä¸Šä¸‹ä¸¦ã³ */
      gap: 10px;
      padding: 10px;
    }

    /* ä¸Šï¼ˆå•é¡Œï¼‰ãƒ»ä¸‹ï¼ˆæ“ä½œï¼‰ãƒ‘ãƒãƒ«ã®è¦‹ãŸç›® */
    .top, .bottom {
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 12px;
      display: flex;
      flex-direction: column;
      min-height: 0; /* Flex å†…ã§ç¸®ã‚ã‚‰ã‚Œã‚‹ã‚ˆã†ã« */
    }
    .top { flex: 1; gap: 8px; }    /* ä¸Šå´ã¯å¯å¤‰é«˜ã•ï¼ˆä¸»é ˜åŸŸï¼‰ */
    .bottom { gap: 12px; }          /* ä¸‹å´ã¯ãƒœã‚¿ãƒ³ç¾¤ */

    /* ãƒ˜ãƒƒãƒ€ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºãªã©ï¼‰ */
    header { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 2px; }
    h1 { font-size: 16px; margin: 0; color: var(--text); font-weight: 700; }
    .sub { color: var(--muted); font-size: 12px; }

    /* ãƒ—ãƒ¬ã‚¤ã‚¨ãƒªã‚¢ï¼šç«¯æœ«ã«åˆã‚ã›ã¦é«˜ã•ã‚’èª¿æ•´ */
    .arena{ position: relative; background: radial-gradient(120% 100% at 100% 0%, #0a1530, #091023 60%);
      border-radius: 12px; overflow: hidden; width: 100%; flex: 1; min-height: 0; }

    .overlay-center{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background: radial-gradient(transparent 40%, rgba(0,0,0,.35)); pointer-events:none; user-select:none;
      font-weight: 800; text-shadow: 0 10px 30px rgba(0,0,0,.55); }
    .count-num{ font-size: clamp(48px, 12vw, 120px); letter-spacing: .02em; opacity:.98; }

    .num{ position:absolute; width:84px; height:84px; min-width:56px; min-height:56px; border-radius: 999px;
      border:1px solid rgba(255,255,255,.12); background:#172033; color:#eef2ff; font-weight:900; font-size: 30px;
      display:flex; align-items:center; justify-content:center; cursor:pointer; touch-action: manipulation;
      transition: transform 180ms, background 180ms, box-shadow 180ms, filter 180ms;
      box-shadow: 0 6px 14px rgba(0,0,0,.25); user-select:none; }
    .num:focus-visible{ outline:2px solid var(--accent); outline-offset:3px }
    .num:active{ transform: scale(.94) }
    .num.correct{ background: var(--ok); border-color: var(--ok); box-shadow: 0 8px 24px rgba(76, 217, 100, .35); }
    .num.wrong{ background: var(--ng); border-color: var(--ng); box-shadow: 0 8px 24px rgba(255, 59, 48, .35); animation: shake .28s ease-in-out }
    @keyframes shake { 0%,100%{ transform: translateX(0) } 20%{ transform: translateX(-6px) } 40%{ transform: translateX(6px) } 60%{ transform: translateX(-4px) } 80%{ transform: translateX(4px) } }

    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”¨ãƒ”ãƒ«è¡¨ç¤º */
    .hud { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
    .pill { padding: 6px 10px; border-radius: 999px; background: #14182a; border: 1px solid #2a2f4a; color: var(--muted); font-size: 12px; }

    /* ãƒœã‚¿ãƒ³ */
    .actions { display: flex; gap: 8px; }
    button.secondary { flex: 1; padding: 12px; border-radius: 12px; border: 1px solid #2d3352; background: #1a1f36; color: var(--text); font-weight: 700; transition: transform 180ms; }
    button.primary   { flex: 1; padding: 12px; border-radius: 12px; border: 0; background: var(--accent); color: #00121a; font-weight: 900; transition: transform 180ms; }
    button.secondary:active, button.primary:active { transform: translateY(1px) scale(.98); }

    /* ã‚µã‚¦ãƒ³ãƒ‰ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ */
    .sound-toggle { 
      appearance: none; border: 1px solid #2d3352; background: var(--btn); color: var(--text);
      border-radius: 10px; padding: 10px 12px; font-size: 16px; cursor: pointer;
      transition: transform 180ms, filter 180ms; touch-action: manipulation; 
    }
    .sound-toggle:active { transform: scale(.96) }
    .sound-toggle:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px }

    /* ãƒˆãƒ¼ã‚¹ãƒˆï¼ˆæ­£è§£ï¼ä¸æ­£è§£ã®ä¸€æ™‚è¡¨ç¤ºï¼‰ */
    .toast { position: absolute; inset: 0; display: grid; place-items: center; pointer-events: none; }
    .toast > div { font-size: 40px; font-weight: 900; opacity: 0; transform: translateY(8px) scale(.98); transition: opacity .2s, transform .2s; padding: 8px 16px; border-radius: 12px; }
    .toast.show > .ok { color: var(--ok); opacity: 1; transform: translateY(0) scale(1); background: rgba(30, 60, 30, .25); }
    .toast.show > .ng { color: var(--ng); opacity: 1; transform: translateY(0) scale(1); background: rgba(80, 20, 20, .25); }

    /* ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚„çµæœç”¨ã®åŠé€æ˜ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .overlay { position: absolute; inset: 0; display: grid; place-items: center; background: rgba(0,0,0,.35); border-radius: 12px; opacity: 0; pointer-events: none; transition: opacity .2s; }
    .overlay.show { opacity: 1; pointer-events: auto; }
    .overlay .big { font-size: clamp(40px, 8vw, 84px); font-weight: 900; letter-spacing: .04em; }
    .overlay .panel { background: #0f1328; border: 1px solid #2a2f4a; padding: 16px 18px; border-radius: 14px; box-shadow: var(--shadow); text-align: center; }
    .overlay .panel h2 { margin: 0 0 8px; font-size: 18px; }
    .overlay .panel p  { margin: 4px 0; color: var(--muted); font-size: 14px; }

    .hidden{ display:none !important }

    /* ãƒ¢ãƒã‚¤ãƒ«ç¸®å°æ™‚ã®ä½™ç™½æœ€é©åŒ– */
    @media (max-width: 800px) {
      .app { gap: 8px; padding: 8px; }
      .actions { gap: 6px; }
      button.secondary, button.primary { padding: 10px; font-size: 14px; }
    }
  </style>
</head>
<body>
  <div class="app" id="app">

    <!-- ä¸Šï¼šå•é¡Œãƒ‘ãƒãƒ«ï¼ˆHUD + Arena + ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ -->
    <section class="top" aria-label="å•é¡Œãƒ‘ãƒãƒ«">
      <div class="hud">
        <div class="pill" id="qIndicator" aria-live="polite">ã‚¿ãƒƒãƒ—ã§é–‹å§‹ã§ãã¾ã™</div>
        <div style="display: flex; gap: 8px; align-items: center;">
          <div class="pill" id="liveTime">Time: 0.00s</div>
          <div class="pill" id="liveCorrect">Correct: 0</div>
          <button class="sound-toggle" id="soundToggle" aria-label="ã‚µã‚¦ãƒ³ãƒ‰ON/OFF" title="ã‚µã‚¦ãƒ³ãƒ‰ON/OFF">ğŸ”Š</button>
        </div>
      </div>
      
      <div class="arena" id="arena" aria-label="ãƒ—ãƒ¬ã‚¤ã‚¨ãƒªã‚¢">
        <div class="overlay-center" id="countOverlay"><div class="count-num" id="countText"></div></div>
        <!-- ãƒˆãƒ¼ã‚¹ãƒˆï¼ˆæ­£è§£ï¼ä¸æ­£è§£ã®ç¬é–“è¡¨ç¤ºï¼‰ -->
        <div class="toast" id="toast">
          <div class="ok">æ­£è§£</div>
          <div class="ng">ä¸æ­£è§£</div>
        </div>
        <!-- ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚„çµæœãƒ€ã‚¤ã‚¢ãƒ­ã‚°ç”¨ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
        <div class="overlay" id="overlay"><div class="big" id="overlayText"></div></div>
      </div>
    </section>

    <!-- ä¸‹ï¼šæ“ä½œãƒ‘ãƒãƒ« -->
    <section class="bottom" aria-label="æ“ä½œãƒ‘ãƒãƒ«">
      <div id="panel">
        <div id="titlePanel">
          <header>
            <h1>ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—åå°„ã‚²ãƒ¼ãƒ </h1>
            <div class="pill" id="bestPill" aria-live="polite" aria-label="ãƒ™ã‚¹ãƒˆè¨˜éŒ²è¡¨ç¤º">Best --/10, --.-s</div>
          </header>
          <div class="sub">ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºã‚‹1æ¡ã®æ•°å­—ã‹ã‚‰<strong>æœ€å¤§ã®æ•°å­—</strong>ã‚’ã‚¿ãƒƒãƒ—ã€‚10å•é€£ç¶šã§<strong>åˆè¨ˆã‚¿ã‚¤ãƒ </strong>ã¨<strong>æ­£ç­”æ•°</strong>ã‚’ç«¶ã„ã¾ã™ã€‚</div>
          <div class="actions">
            <button id="howBtn" class="secondary" aria-label="éŠã³æ–¹ã‚’è¦‹ã‚‹">éŠã³æ–¹</button>
            <button id="startBtn" class="primary" aria-label="ã‚²ãƒ¼ãƒ é–‹å§‹">ã‚¿ãƒƒãƒ—ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
          </div>
        </div>

        <div id="howPanel" class="hidden">
          <header>
            <h1>éŠã³æ–¹</h1>
          </header>
          <ul class="sub" style="margin: 0; padding-left: 16px;">
            <li>æœ€åˆã«ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã€Œ3,2,1, START!ã€ãŒ1å›ã ã‘è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
            <li>å„å•é¡Œã¯<strong>3ï½6å€‹</strong>ã®æ•°å­—ï¼ˆ0ï½9ï¼‰ãŒãƒ©ãƒ³ãƒ€ãƒ ä½ç½®ã«å‡ºç¾ã—ã¾ã™ã€‚</li>
            <li><strong>æœ€å¤§ã®æ•°å­—</strong>ã‚’<strong>ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—</strong>ã—ã¦é¸ã³ã¾ã™ã€‚ï¼ˆiPhone/iPadå¯¾å¿œï¼‰</li>
            <li>10å•çµ‚äº†ã§çµæœè¡¨ç¤ºã€‚ãƒ™ã‚¹ãƒˆã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã€ãƒ˜ãƒƒãƒ€ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
            <li>ã‚µã‚¦ãƒ³ãƒ‰ã¯å³ä¸Šãƒœã‚¿ãƒ³ã§ON/OFFï¼ˆè¨­å®šã¯ä¿å­˜ã•ã‚Œã¾ã™ï¼‰ã€‚</li>
          </ul>
          <div class="actions">
            <button id="backBtn" class="secondary">æˆ»ã‚‹</button>
            <button id="startBtn2" class="primary">ä»Šã™ãã‚¹ã‚¿ãƒ¼ãƒˆ</button>
          </div>
        </div>

        <div id="resultPanel" class="hidden" aria-live="polite">
          <header>
            <h1>çµæœ</h1>
          </header>
          <p id="resultText" style="font-size:18px; margin: 8px 0; color: var(--text);"></p>
          <p id="bestText" class="sub" style="margin: 4px 0;"></p>
          <div class="actions">
            <button id="toTitleBtn" class="secondary" aria-label="ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹">ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
            <button id="retryBtn" class="primary" aria-label="ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤">ã‚‚ã†ä¸€åº¦</button>
          </div>
        </div>
      </div>
    </section>

  </div>

  <script>
  ;(() => {
    const $ = sel => document.querySelector(sel);
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
    const arena = $('#arena');
    const qIndicator = $('#qIndicator');
    const liveTime = $('#liveTime');
    const liveCorrect = $('#liveCorrect');
    const bestPill = $('#bestPill');
    const soundToggle = $('#soundToggle');
    const countOverlay = $('#countOverlay');
    const countText = $('#countText');
    const titlePanel = $('#titlePanel');
    const howPanel = $('#howPanel');
    const resultPanel = $('#resultPanel');
    const startBtn = $('#startBtn');
    const startBtn2 = $('#startBtn2');
    const howBtn = $('#howBtn');
    const backBtn = $('#backBtn');
    const retryBtn = $('#retryBtn');
    const toTitleBtn = $('#toTitleBtn');
    const resultText = $('#resultText');
    const bestText = $('#bestText');
    const toast = $('#toast');
    const overlay = $('#overlay');
    const overlayText = $('#overlayText');

    // ---- ä¹±æ•°ï¼ˆcrypto å„ªå…ˆï¼‰ ----
    function randInt(min, max){
      if (window.crypto?.getRandomValues){
        const range = max - min + 1; const maxUnbiased = Math.floor(0xFFFFFFFF / range) * range; let x;
        do { const buf = new Uint32Array(1); crypto.getRandomValues(buf); x = buf[0]; } while (x >= maxUnbiased);
        return min + (x % range);
      }
      return Math.floor(Math.random()* (max-min+1)) + min;
    }

    // ---- Web Audio ----
    let audioCtx = null; let soundOn = true; const SOUND_KEY = 'soundOn';
    const storedSound = localStorage.getItem(SOUND_KEY); if (storedSound !== null) soundOn = storedSound === 'true';
    function updateSoundUI(){ soundToggle.textContent = soundOn ? 'ğŸ”Š' : 'ğŸ”‡'; soundToggle.setAttribute('aria-label', soundOn ? 'ã‚µã‚¦ãƒ³ãƒ‰ON' : 'ã‚µã‚¦ãƒ³ãƒ‰OFF'); }
    updateSoundUI();
    function ensureAudioContext(){
      if (!audioCtx){ try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e){ audioCtx = null; } }
      if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
    }
    function beep({freq=440, duration=0.12, type='sine', volume=0.15, when=0}={}){
      if (!soundOn) return; ensureAudioContext(); if (!audioCtx) return;
      const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
      osc.type = type; osc.frequency.value = freq; gain.gain.value = volume; osc.connect(gain).connect(audioCtx.destination);
      const now = audioCtx.currentTime + when; osc.start(now); gain.gain.setValueAtTime(volume, now);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + duration); osc.stop(now + duration + 0.02);
    }
    soundToggle.addEventListener('pointerup', () => { soundOn = !soundOn; localStorage.setItem(SOUND_KEY, String(soundOn)); updateSoundUI(); if (soundOn) beep({freq:880, duration:.08, type:'square', volume:.12}); }, {passive:true});

    // ---- ãƒ™ã‚¹ãƒˆè¨˜éŒ² ----
    const BEST_CORRECT_KEY = 'bestCorrect'; const BEST_TIME_KEY = 'bestTimeMs';
    function getBest(){ const c = Number(localStorage.getItem(BEST_CORRECT_KEY) || 0); const t = Number(localStorage.getItem(BEST_TIME_KEY) || 0); return {correct:c, timeMs:t}; }
    function setBest(correct, timeMs){ localStorage.setItem(BEST_CORRECT_KEY, String(correct)); localStorage.setItem(BEST_TIME_KEY, String(timeMs)); }
    function betterThan(a,b){ if (a.correct !== b.correct) return a.correct > b.correct; if (b.timeMs===0) return true; return a.timeMs < b.timeMs; }
    function fmtTime(ms){ return (ms/1000).toFixed(2) + 's'; }
    function updateBestPill(){ const best = getBest(); bestPill.textContent = (best.timeMs>0 || best.correct>0) ? `Best ${best.correct}/10, ${(best.timeMs/1000).toFixed(2)}s` : 'Best --/10, --.-s'; }
    updateBestPill();

    // ---- ã‚²ãƒ¼ãƒ çŠ¶æ…‹ ----
    const TOTAL_Q = 10; let questionIndex = 0; let correctCount = 0; let startTime = 0; let timerRAF = null; let buttons = []; let resizeQueued = false; let lock = false;
    window.addEventListener('resize', () => { resizeQueued = true; });

    function resetHUD(){ qIndicator.textContent = 'ã‚¿ãƒƒãƒ—ã§é–‹å§‹ã§ãã¾ã™'; liveTime.textContent = 'Time: 0.00s'; liveCorrect.textContent = 'Correct: 0'; }

    function showTitle(){ arena.innerHTML = '<div class="overlay-center" id="countOverlay"><div class="count-num" id="countText"></div></div><div class="toast" id="toast"><div class="ok">æ­£è§£</div><div class="ng">ä¸æ­£è§£</div></div><div class="overlay" id="overlay"><div class="big" id="overlayText"></div></div>';
      resultPanel.classList.add('hidden'); howPanel.classList.add('hidden'); titlePanel.classList.remove('hidden'); resetHUD(); }
    function showHow(){ titlePanel.classList.add('hidden'); howPanel.classList.remove('hidden'); }
    function showResult(correct, ms){ titlePanel.classList.add('hidden'); howPanel.classList.add('hidden'); resultPanel.classList.remove('hidden');
      const bestOld = getBest(); const cand = {correct, timeMs: ms}; let updated=false; if (betterThan(cand,bestOld)){ setBest(correct, ms); updated=true; }
      updateBestPill(); resultText.textContent = `æ­£ç­”æ•°ï¼š${correct} / ${TOTAL_Q}ã€€ï½œã€€åˆè¨ˆã‚¿ã‚¤ãƒ ï¼š${fmtTime(ms)}`;
      bestText.textContent = updated ? 'ğŸ‰ ãƒ™ã‚¹ãƒˆè¨˜éŒ²ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼' : `ãƒ™ã‚¹ãƒˆï¼š${bestOld.correct}/10, ${bestOld.timeMs?fmtTime(bestOld.timeMs):'--.-s'}`; }

    // ãƒˆãƒ¼ã‚¹ãƒˆã¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤æ©Ÿèƒ½
    function showToast(ok){
      const toastEl = $('#toast');
      toastEl.classList.remove('show'); void toastEl.offsetHeight;
      toastEl.classList.add('show');
      toastEl.children[0].style.display = ok ? 'block' : 'none';
      toastEl.children[1].style.display = ok ? 'none' : 'block';
      setTimeout(()=>toastEl.classList.remove('show'), 650);
    }

    function showOverlay(text){ 
      const overlayEl = $('#overlay'); const overlayTextEl = $('#overlayText');
      overlayTextEl.textContent = text; overlayEl.classList.add('show'); 
    }
    function hideOverlay(){ $('#overlay').classList.remove('show'); }

    // 3,2,1,START ã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ï¼ˆéŸ³ä»˜ãï¼‰
    function countdown3(onDone){
      showOverlay('3'); beep({freq:480, duration:.06, type:'square', volume:.16});
      setTimeout(()=>{ showOverlay('2'); beep({freq:480, duration:.06, type:'square', volume:.16}); }, 1000);
      setTimeout(()=>{ showOverlay('1'); beep({freq:480, duration:.06, type:'square', volume:.16}); }, 2000);
      setTimeout(()=>{ showOverlay('START'); beep({freq:700, duration:.08, type:'triangle', volume:.20}); beep({freq:1000, duration:.10, type:'triangle', volume:.18, when:.08}); setTimeout(hideOverlay, 350); onDone(); }, 3000);
    }

    function aabbOverlap(a,b,margin=8){ return !((a.x + a.w + margin) <= b.x || (b.x + b.w + margin) <= a.x || (a.y + a.h + margin) <= b.y || (b.y + b.h + margin) <= a.y); }

    function layoutButtons(values){
      const rect = arena.getBoundingClientRect(); const base = Math.min(rect.width, rect.height);
      let size = clamp(Math.floor(base/4.8), 56, 100); let margin = 8; let tries=0;
      while (tries++ < 16){ const placed = []; let ok = true; for (let i=0;i<values.length;i++){
          let done=false; for (let t=0;t<220;t++){ const x = randInt(0, Math.max(0, Math.floor(rect.width - size)));
              const y = randInt(0, Math.max(0, Math.floor(rect.height - size))); const me = {x,y,w:size,h:size};
              if (placed.every(p=>!aabbOverlap(me,p,margin))){ placed.push(me); done=true; break; } }
          if (!done){ ok=false; break; } }
        if (ok) return {rects: placed, size}; if (margin>4) margin -= 2; else size = Math.max(56, Math.floor(size*0.9)); }
      const cols = Math.ceil(Math.sqrt(values.length)); const rows = Math.ceil(values.length/cols);
      const gw = rect.width / cols, gh = rect.height / rows; const gsize = clamp(Math.floor(Math.min(gw,gh)*0.7), 56, 96);
      const rects = values.map((_,i)=>{ const r = Math.floor(i/cols), c = i%cols; const cx = c*gw + (gw-gsize)/2, cy = r*gh + (gh-gsize)/2;
        const jx = clamp(cx + randInt(-12,12), 0, rect.width - gsize); const jy = clamp(cy + randInt(-12,12), 0, rect.height - gsize);
        return {x:Math.floor(jx), y:Math.floor(jy), w:gsize, h:gsize}; });
      return {rects, size:gsize}; }

    function makeNumbers(){ const n = randInt(3,6); return Array.from({length:n}, () => randInt(0,9)); }

    function registerTap(el, handler){
      let used = false; const wrap = (e)=>{ if (used || lock) return; used = true; handler(e); setTimeout(()=>{ used=false; }, 0); };
      el.addEventListener('pointerup', wrap, {passive:true});
      el.addEventListener('click', wrap, {passive:true});
    }

    function renderQuestion(){
      qIndicator.textContent = `å•é¡Œ ${questionIndex+1} / ${TOTAL_Q}`; liveCorrect.textContent = `Correct: ${correctCount}`;
      const values = makeNumbers(); const maxVal = Math.max(...values);
      arena.innerHTML = '<div class="overlay-center" id="countOverlay" style="display:none"><div class="count-num" id="countText"></div></div><div class="toast" id="toast"><div class="ok">æ­£è§£</div><div class="ng">ä¸æ­£è§£</div></div><div class="overlay" id="overlay"><div class="big" id="overlayText"></div></div>';
      const {rects} = layoutButtons(values); buttons = [];
      values.forEach((v,i)=>{ const r = rects[i]; const btn = document.createElement('button');
        btn.className = 'num'; btn.style.left = r.x+'px'; btn.style.top = r.y+'px'; btn.style.width = r.w+'px'; btn.style.height = r.h+'px';
        btn.textContent = String(v); btn.setAttribute('aria-label', `æ•°å­— ${v}`); btn.dataset.val = String(v);
        registerTap(btn, () => onTap(btn, v, maxVal)); arena.appendChild(btn); buttons.push(btn); });
      if (questionIndex === 1){ startTime = performance.now(); tickTime(); }
      resizeQueued = false;
    }

    function tickTime(){ cancelAnimationFrame(timerRAF); const loop = () => { const now = performance.now(); const elapsed = now - startTime; liveTime.textContent = `Time: ${(elapsed/1000).toFixed(2)}s`; timerRAF = requestAnimationFrame(loop); }; timerRAF = requestAnimationFrame(loop); }

    function onTap(btn, value, maxVal){ if (lock) return; const correct = (value === maxVal);
      if (correct){ btn.classList.add('correct'); beep({freq:900, duration:.1, type:'square', volume:.12}); correctCount++; showToast(true); }
      else { btn.classList.add('wrong'); beep({freq:250, duration:.12, type:'sawtooth', volume:.12}); showToast(false); }
      lock = true; setTimeout(()=>{ lock = false; nextQuestion(); }, 240);
    }

    function nextQuestion(){ 
      questionIndex++; 
      if (questionIndex > TOTAL_Q){ 
        cancelAnimationFrame(timerRAF); 
        const end = performance.now(); 
        const totalMs = end - startTime; 
        showResult(correctCount, totalMs); 
        return; 
      }
      renderQuestion(); 
    }

    async function startGame(){ 
      questionIndex = 0; correctCount = 0; lock = false; resetHUD(); 
      titlePanel.classList.add('hidden'); howPanel.classList.add('hidden'); resultPanel.classList.add('hidden'); 
      ensureAudioContext(); 
      qIndicator.textContent = 'ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ä¸­';
      countdown3(()=>{ questionIndex = 0; renderQuestion(); }); 
    }

    // ---- ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¿ãƒƒãƒ—ä¸»ä½“ï¼‰ ----
    registerTap(startBtn, startGame);
    if (startBtn2) registerTap(startBtn2, startGame);
    registerTap(howBtn, showHow);
    registerTap(backBtn, showTitle);
    registerTap(retryBtn, startGame);
    registerTap(toTitleBtn, showTitle);

    // åˆæœŸè¡¨ç¤º
    showTitle();
  })();
  </script>
</body>
</html>