<!--
A) ä»•æ§˜ã®è¦ç´„
- ç”»é¢ã¯ä¸Šä¸‹ 2 åˆ†å‰²ã€‚
  - ä¸Šï¼šCanvas ã«å·¦å³åˆ†å‰²ã§ 1ã€œ10 å€‹ã®ä¸¸ã‚’ã€Œé‡ãªã‚‰ãªã„ã‚ˆã†ã«ã€ãƒ©ãƒ³ãƒ€ãƒ é…ç½®ã€‚
  - ä¸‹ï¼šã‚¹ã‚¿ãƒ¼ãƒˆï¼ãƒªãƒˆãƒ©ã‚¤ãƒœã‚¿ãƒ³ï¼‹éŠã³æ–¹èª¬æ˜ã€‚
- ã‚¹ã‚¿ãƒ¼ãƒˆæŠ¼ä¸‹ â†’ 3 ç§’ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ â†’ 10 ãƒ©ã‚¦ãƒ³ãƒ‰é€£ç¶šå‡ºé¡Œã€‚
- å„ãƒ©ã‚¦ãƒ³ãƒ‰ã§å·¦å³ãã‚Œãã‚Œã«ç•°ãªã‚‹å€‹æ•°ï¼ˆå¿…ãšä¸ç­‰ï¼‰ã®ä¸¸ã‚’é…ç½®ã€‚
- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å·¦åŠåˆ† or å³åŠåˆ†ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€Œå¤šã„ã»ã†ã€ã‚’é¸æŠã€‚
- 10 ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†å¾Œã€æ­£ç­”æ•°ã‚’è¡¨ç¤ºã€‚
- iPhone / iPad å¯¾å¿œï¼ˆviewportã€Pointer Eventsã€åˆå›ã‚¿ãƒƒãƒ—ã§ WebAudio è§£éŒ ï¼‰ã€‚
- 1 ãƒ•ã‚¡ã‚¤ãƒ«å®Œçµã€‚å¤–éƒ¨ CDN ä¸ä½¿ç”¨ã€‚GitHub Pages é…å‚™å¯ã€‚
- ãƒ‡ã‚¶ã‚¤ãƒ³ã¯ä»–ã®ã‚²ãƒ¼ãƒ ï¼ˆbiggest_number.html, how_many_bolls.htmlï¼‰ã¨çµ±ä¸€ã€‚
-->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>å·¦å³æ¯”è¼ƒï¼ˆä¸¸ã®æ•°ï¼‰</title>
  <style>
    /* =========================
       é…è‰²ã‚„å½±ã®ãƒˆãƒ¼ã‚¯ãƒ³
       ========================= */
    :root {
      --bg: #0f1220;
      --panel: #171a2a;
      --panel2: #0c1020;
      --text: #e8ecf1;
      --muted: #99a3b3;
      --accent: #5cc8ff;  /* ä¸»è¦ãƒœã‚¿ãƒ³è‰² */
      --ok: #4cd964;      /* æ­£è§£è‰² */
      --ng: #ff3b30;      /* ä¸æ­£è§£è‰² */
      --btn: #22263a;
      --btnActive: #2f3552;
      --shadow: 0 8px 24px rgba(0,0,0,.35);
    }

    /* ã‚¿ãƒƒãƒ—æ™‚ã®é’ã„ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ç„¡åŠ¹åŒ– */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; }

    /* ç”»é¢å…¨ä½“ã®èƒŒæ™¯ã¨åŸºæœ¬ãƒ•ã‚©ãƒ³ãƒˆ */
    body {
      margin: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      background: radial-gradient(100% 100% at 0% 0%, #0e142a, #0a0d1a 60%), var(--bg);
      color: var(--text);
      font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      height: 100svh;      /* iOS ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å¤‰å‹•å¯¾ç­– */
      overflow: hidden;     /* èƒŒæ™¯ã®ã¯ã¿å‡ºã—é˜²æ­¢ */
      touch-action: manipulation; /* ã‚¿ãƒƒãƒé…å»¶ã®å›é¿ */
    }

    /* ã‚¢ãƒ—ãƒªã®ä¸Šä¸‹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .app {
      height: 100%;
      display: flex;
      flex-direction: column; /* ä¸Šä¸‹ä¸¦ã³ */
      gap: 10px;
      padding: 10px;
    }

    /* ä¸Šï¼ˆå•é¡Œï¼‰ãƒ»ä¸‹ï¼ˆæ“ä½œï¼‰ãƒ‘ãƒãƒ«ã®è¦‹ãŸç›® */
    .top, .bottom {
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 12px;
      display: flex;
      flex-direction: column;
      min-height: 0; /* Flex å†…ã§ç¸®ã‚ã‚‰ã‚Œã‚‹ã‚ˆã†ã« */
    }
    .top { flex: 1; gap: 8px; }    /* ä¸Šå´ã¯å¯å¤‰é«˜ã•ï¼ˆä¸»é ˜åŸŸï¼‰ */
    .bottom { gap: 12px; }          /* ä¸‹å´ã¯ãƒœã‚¿ãƒ³ç¾¤ */

    /* ãƒ˜ãƒƒãƒ€ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºãªã©ï¼‰ */
    header { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 2px; }
    h1 { font-size: 16px; margin: 0; color: var(--text); font-weight: 700; }
    .sub { color: var(--muted); font-size: 12px; }

    /* ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ï¼šCanvas ã‚’å«ã‚€ */
    .game-area{ position: relative; background: radial-gradient(120% 100% at 100% 0%, #0a1530, #091023 60%);
      border-radius: 12px; overflow: hidden; width: 100%; flex: 1; min-height: 0; }

    /* Canvas ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    canvas {
      width: 100%; height: 100%; display: block; border-radius: 12px;
      background: #0f1220; touch-action: none; /* iOSï¼šã‚¿ãƒƒãƒ—æ“ä½œã®äºˆæœŸã›ã¬ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç„¡åŠ¹ */
    }

    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”¨ãƒ”ãƒ«è¡¨ç¤º */
    .hud { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
    .pill { padding: 6px 10px; border-radius: 999px; background: #14182a; border: 1px solid #2a2f4a; color: var(--muted); font-size: 12px; }

    /* ãƒœã‚¿ãƒ³ */
    .actions { display: flex; gap: 8px; }
    button.secondary { flex: 1; padding: 12px; border-radius: 12px; border: 1px solid #2d3352; background: #1a1f36; color: var(--text); font-weight: 700; transition: transform 180ms; }
    button.primary   { flex: 1; padding: 12px; border-radius: 12px; border: 0; background: var(--accent); color: #00121a; font-weight: 900; transition: transform 180ms; }
    button.secondary:active, button.primary:active { transform: translateY(1px) scale(.98); }
    button:disabled { opacity: 0.5; filter: grayscale(30%); }

    /* ãƒˆãƒ¼ã‚¹ãƒˆï¼ˆæ­£è§£ï¼ä¸æ­£è§£ã®ä¸€æ™‚è¡¨ç¤ºï¼‰ */
    .toast { position: absolute; inset: 0; display: grid; place-items: center; pointer-events: none; z-index: 10; }
    .toast > div { font-size: 40px; font-weight: 900; opacity: 0; transform: translateY(8px) scale(.98); transition: opacity .2s, transform .2s; padding: 8px 16px; border-radius: 12px; }
    .toast.show > .ok { color: var(--ok); opacity: 1; transform: translateY(0) scale(1); background: rgba(30, 60, 30, .25); }
    .toast.show > .ng { color: var(--ng); opacity: 1; transform: translateY(0) scale(1); background: rgba(80, 20, 20, .25); }

    /* ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚„çµæœç”¨ã®åŠé€æ˜ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .overlay { position: absolute; inset: 0; display: grid; place-items: center; background: rgba(0,0,0,.35); border-radius: 12px; opacity: 0; pointer-events: none; transition: opacity .2s; z-index: 20; }
    .overlay.show { opacity: 1; pointer-events: auto; }
    .overlay .big { font-size: clamp(40px, 8vw, 84px); font-weight: 900; letter-spacing: .04em; }
    .overlay .panel { background: #0f1328; border: 1px solid #2a2f4a; padding: 16px 18px; border-radius: 14px; box-shadow: var(--shadow); text-align: center; }
    .overlay .panel h2 { margin: 0 0 8px; font-size: 18px; }
    .overlay .panel p  { margin: 4px 0; color: var(--muted); font-size: 14px; }

    .hidden{ display:none !important }

    /* ãƒ¢ãƒã‚¤ãƒ«ç¸®å°æ™‚ã®ä½™ç™½æœ€é©åŒ– */
    @media (max-width: 800px) {
      .app { gap: 8px; padding: 8px; }
      .actions { gap: 6px; }
      button.secondary, button.primary { padding: 10px; font-size: 14px; }
    }
  </style>
</head>
<body>
  <div class="app" id="app">

    <!-- ä¸Šï¼šå•é¡Œãƒ‘ãƒãƒ«ï¼ˆHUD + Canvas + ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ -->
    <section class="top" aria-label="å•é¡Œãƒ‘ãƒãƒ«">
      <div class="hud">
        <div class="pill" id="qIndicator" aria-live="polite">ã‚¿ãƒƒãƒ—ã§é–‹å§‹ã§ãã¾ã™</div>
        <div style="display: flex; gap: 8px; align-items: center;">
          <div class="pill" id="roundDisplay">Round: 0/10</div>
          <div class="pill" id="scoreDisplay">Score: 0</div>
        </div>
      </div>
      
      <div class="game-area" id="gameArea" aria-label="ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢">
        <!-- ãƒ¡ã‚¤ãƒ³ã®Canvasï¼ˆä¸¸ã®æç”»ç”¨ï¼‰ -->
        <canvas id="game" aria-label="å·¦å³ã«æã‹ã‚ŒãŸä¸¸ã®æ•°ãŒå¤šã„ã»ã†ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„"></canvas>
        <!-- ãƒˆãƒ¼ã‚¹ãƒˆï¼ˆæ­£è§£ï¼ä¸æ­£è§£ã®ç¬é–“è¡¨ç¤ºï¼‰ -->
        <div class="toast" id="toast">
          <div class="ok">æ­£è§£ï¼</div>
          <div class="ng">ã¯ãšã‚Œâ€¦</div>
        </div>
        <!-- ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚„çµæœãƒ€ã‚¤ã‚¢ãƒ­ã‚°ç”¨ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
        <div class="overlay" id="overlay"><div class="big" id="overlayText"></div></div>
      </div>
    </section>

    <!-- ä¸‹ï¼šæ“ä½œãƒ‘ãƒãƒ« -->
    <section class="bottom" aria-label="æ“ä½œãƒ‘ãƒãƒ«">
      <div id="panel">
        <div id="titlePanel">
          <header>
            <h1>å·¦å³æ¯”è¼ƒï¼ˆä¸¸ã®æ•°ï¼‰</h1>
            <div class="pill" id="bestPill" aria-live="polite" aria-label="ãƒ™ã‚¹ãƒˆè¨˜éŒ²è¡¨ç¤º">Best: --/10</div>
          </header>
          <div class="sub">å·¦åŠåˆ† or å³åŠåˆ†ã‚’ã‚¿ãƒƒãƒ—ï¼ˆiPhone/iPadå¯¾å¿œï¼‰ã€‚å„ãƒ©ã‚¦ãƒ³ãƒ‰ã¯1ï½10å€‹ã®ä¸¸ã‚’å·¦å³ã«æç”»ï¼ˆé‡ãªã‚Šãªã—ï¼‰ã€‚ã©ã¡ã‚‰ãŒå¤šã„ã‹ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</div>
          <div class="actions">
            <button id="howBtn" class="secondary" aria-label="éŠã³æ–¹ã‚’è¦‹ã‚‹">éŠã³æ–¹</button>
            <button id="startBtn" class="primary" aria-label="ã‚²ãƒ¼ãƒ é–‹å§‹">ã‚¿ãƒƒãƒ—ã—ã¦é–‹å§‹</button>
          </div>
        </div>

        <div id="howPanel" class="hidden">
          <header>
            <h1>éŠã³æ–¹</h1>
          </header>
          <ul class="sub" style="margin: 0; padding-left: 16px;">
            <li>æœ€åˆã«ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã€Œ3,2,1, START!ã€ãŒ1å›ã ã‘è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
            <li>ç”»é¢ãŒå·¦å³ã«åˆ†å‰²ã•ã‚Œã€ãã‚Œãã‚Œã«<strong>1ï½10å€‹</strong>ã®ä¸¸ãŒãƒ©ãƒ³ãƒ€ãƒ é…ç½®ã•ã‚Œã¾ã™ã€‚</li>
            <li><strong>ä¸¸ã®æ•°ãŒå¤šã„ã»ã†</strong>ã®ç”»é¢åŠåˆ†ã‚’<strong>ã‚¿ãƒƒãƒ—</strong>ã—ã¦é¸æŠã—ã¾ã™ã€‚</li>
            <li>10ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†ã§çµæœè¡¨ç¤ºã€‚ãƒ™ã‚¹ãƒˆã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã€ãƒ˜ãƒƒãƒ€ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
            <li>ä¸¸ã¯é‡ãªã‚‰ãªã„ã‚ˆã†é…ç½®ã•ã‚Œã€å·¦å³ã§å¿…ãšç•°ãªã‚‹å€‹æ•°ã«ãªã‚Šã¾ã™ã€‚</li>
          </ul>
          <div class="actions">
            <button id="backBtn" class="secondary">æˆ»ã‚‹</button>
            <button id="startBtn2" class="primary">ä»Šã™ãã‚¹ã‚¿ãƒ¼ãƒˆ</button>
          </div>
        </div>

        <div id="resultPanel" class="hidden" aria-live="polite">
          <header>
            <h1>çµæœ</h1>
          </header>
          <p id="resultText" style="font-size:18px; margin: 8px 0; color: var(--text);"></p>
          <p id="bestText" class="sub" style="margin: 4px 0;"></p>
          <div class="actions">
            <button id="toTitleBtn" class="secondary" aria-label="ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹">ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
            <button id="retryBtn" class="primary" aria-label="ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤">ã‚‚ã†ä¸€åº¦</button>
          </div>
        </div>
      </div>
    </section>

  </div>

  <script>
  (function(){
    'use strict';

    /* ==========================================================
       å®šæ•°ã¨ã‚²ãƒ¼ãƒ è¨­å®š
       ========================================================== */
    const ROUNDS = 10;            // ç·ãƒ©ã‚¦ãƒ³ãƒ‰æ•°
    const MIN_COUNT = 1;          // æœ€å°ä¸¸æ•°
    const MAX_COUNT = 10;         // æœ€å¤§ä¸¸æ•°
    const MARGIN = 6;             // å††åŒå£«ã®æœ€å°é–“éš”ï¼ˆpxï¼‰
    const PAD = 10;               // å´é¢ã‚„ä¸Šä¸‹ã®ä½™ç™½ï¼ˆpxï¼‰

    /* ==========================================================
       ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼šDOM ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã¨ä¹±æ•°ã€è·é›¢è¨ˆç®—
       ========================================================== */
    const $ = (q, el=document) => el.querySelector(q);
    const rand = (min, max) => Math.random() * (max - min) + min;
    const randInt = (min, max) => Math.floor(rand(min, max + 1));
    const dist2 = (a, b) => { const dx = a.x - b.x, dy = a.y - b.y; return dx * dx + dy * dy; };

    /* ==========================================================
       åŠ¹æœéŸ³ï¼ˆWebAudioï¼‰ï¼šåˆå›ã‚¿ãƒƒãƒ—ã§è§£éŒ  â†’ ç°¡æ˜“ãƒ“ãƒ¼ãƒ—åˆæˆ
       ========================================================== */
    let audioCtx = null;
    let audioUnlocked = false;

    function ensureAudio(){
      if (audioUnlocked) return;
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint:'interactive' });
      if (audioCtx.state !== 'running') audioCtx.resume();
      audioUnlocked = true;
    }

    function beep({ freq=440, dur=0.08, type='sine', gain=0.2, when=0, endGain=0.0001 }){
      if (!audioUnlocked) return;
      const t0 = audioCtx.currentTime + when;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type; o.frequency.setValueAtTime(freq, t0);
      g.gain.setValueAtTime(gain, t0);
      g.gain.exponentialRampToValueAtTime(endGain, t0 + dur);
      o.connect(g).connect(audioCtx.destination);
      o.start(t0); o.stop(t0 + dur + 0.02);
    }

    // ç”¨é€”åˆ¥ã®åŠ¹æœéŸ³
    const sfxTap = () => beep({ freq:280, dur:0.05, type:'triangle', gain:0.15 });
    const sfxOk  = () => { beep({ freq:520, dur:0.07, type:'sine', gain:0.18 }); beep({ freq:820, dur:0.07, type:'sine', gain:0.16, when:0.06 }); };
    const sfxNg  = () => { beep({ freq:180, dur:0.11, type:'square', gain:0.18 }); beep({ freq:140, dur:0.12, type:'square', gain:0.16, when:0.06 }); };
    const sfxTick= () => beep({ freq:480, dur:0.06, type:'square', gain:0.16 });
    const sfxGo  = () => { beep({ freq:700, dur:0.08, type:'triangle', gain:0.20 }); beep({ freq:1000, dur:0.10, type:'triangle', gain:0.18, when:0.08 }); };

    // åˆå›ã‚¿ãƒƒãƒ—ã§è§£éŒ 
    const unlock = () => { ensureAudio(); document.removeEventListener('pointerdown', unlock, true); };
    document.addEventListener('pointerdown', unlock, true);

    /* ==========================================================
       è¦ç´ å‚ç…§ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
       ========================================================== */
    const canvas = $('#game');
    const ctx = canvas.getContext('2d');
    const qIndicator = $('#qIndicator');
    const roundDisplay = $('#roundDisplay');
    const scoreDisplay = $('#scoreDisplay');
    const bestPill = $('#bestPill');
    const toast = $('#toast');
    const overlay = $('#overlay');
    const overlayText = $('#overlayText');

    const titlePanel = $('#titlePanel');
    const howPanel = $('#howPanel');
    const resultPanel = $('#resultPanel');
    const startBtn = $('#startBtn');
    const startBtn2 = $('#startBtn2');
    const howBtn = $('#howBtn');
    const backBtn = $('#backBtn');
    const retryBtn = $('#retryBtn');
    const toTitleBtn = $('#toTitleBtn');
    const resultText = $('#resultText');
    const bestText = $('#bestText');

    /* ==========================================================
       ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®ç®¡ç†
       ========================================================== */
    let dpr = Math.max(1, window.devicePixelRatio || 1);  // ãƒ‡ãƒã‚¤ã‚¹ãƒ”ã‚¯ã‚»ãƒ«æ¯”
    let W = 0, H = 0;                                     // Canvas ã®å®Ÿãƒ”ã‚¯ã‚»ãƒ«ã‚µã‚¤ã‚º
    let round = 0;                                        // ç¾åœ¨ã®ãƒ©ã‚¦ãƒ³ãƒ‰ï¼ˆ1ï½10ï¼‰
    let score = 0;                                        // ç¾åœ¨ã®ã‚¹ã‚³ã‚¢
    let best = Number(localStorage.getItem('cmp_best') || 0); // ãƒ™ã‚¹ãƒˆã‚¹ã‚³ã‚¢
    let state = 'idle';                                   // 'idle' | 'playing' | 'ended'
    let leftCircles = [];                                 // å·¦å´ã®ä¸¸é…åˆ—
    let rightCircles = [];                                // å³å´ã®ä¸¸é…åˆ—
    let leftCount = 0;                                    // å·¦å´ã®ä¸¸æ•°
    let rightCount = 0;                                   // å³å´ã®ä¸¸æ•°
    let roundLocked = false;                              // 1ãƒ©ã‚¦ãƒ³ãƒ‰å†…ã®å¤šé‡å…¥åŠ›é˜²æ­¢

    /* ==========================================================
       ãƒ™ã‚¹ãƒˆè¨˜éŒ²ã®ç®¡ç†
       ========================================================== */
    function updateBestPill(){ 
      bestPill.textContent = best ? `Best: ${Math.min(best, ROUNDS)}/${ROUNDS}` : `Best: --/${ROUNDS}`; 
    }
    updateBestPill();

    /* ==========================================================
       Canvas ã®ãƒªã‚µã‚¤ã‚ºå¯¾å¿œï¼ˆé«˜DPIå¯¾å¿œï¼‰
       ========================================================== */
    function resizeCanvas(){
      const rect = canvas.getBoundingClientRect();
      W = Math.max(320, Math.floor(rect.width * dpr));
      H = Math.max(320, Math.floor(rect.height * dpr));
      canvas.width = W; 
      canvas.height = H;
      ctx.setTransform(1,0,0,1,0,0);
      ctx.scale(dpr, dpr);
      draw();
    }
    window.addEventListener('resize', resizeCanvas, {passive:true});
    window.addEventListener('orientationchange', () => setTimeout(resizeCanvas, 200), {passive:true});

    /* ==========================================================
       å††ã®éé‡è¤‡é…ç½®ãƒ­ã‚¸ãƒƒã‚¯
       ========================================================== */
    function generateSide(sideRect, count){
      // åŠåˆ†ã®é ˜åŸŸå†…ã«å††ã‚’é‡ãªã‚Šãªãé…ç½®ã€‚å¤±æ•—æ™‚ã¯åŠå¾„ã‚’ç¸®ã‚ã¦å†è©¦è¡Œã€‚
      const {x, y, w, h} = sideRect;
      let r = Math.max(10, Math.min(w, h) / 18); // åˆæœŸåŠå¾„
      const maxTries = 6;
      
      for (let attempt = 0; attempt < maxTries; attempt++){
        const circles = [];
        let ok = true;
        
        for (let i = 0; i < count; i++){
          let placed = false;
          for (let t = 0; t < 400; t++){
            const cx = randInt(x + PAD + r, x + w - PAD - r);
            const cy = randInt(y + PAD + r, y + h - PAD - r);
            const c = {x: cx, y: cy, r};
            
            if (circles.every(p => dist2(p, c) >= (p.r + c.r + MARGIN) ** 2)){
              circles.push(c); 
              placed = true; 
              break;
            }
          }
          if (!placed){ ok = false; break; }
        }
        
        if (ok) return circles;
        r = Math.max(8, r * 0.88); // å¤±æ•—ã—ãŸã‚‰å°‘ã—åŠå¾„ã‚’ç¸®ã‚ã‚‹
      }
      
      // æœ€å¾Œã®æ‰‹æ®µï¼šç°¡æ˜“ã‚°ãƒªãƒƒãƒ‰é…ç½®
      const cols = Math.ceil(Math.sqrt(count));
      const rows = Math.ceil(count / cols);
      const gw = w / cols, gh = h / rows;
      const rr = Math.max(8, Math.min(gw, gh) * 0.28);
      const circles = [];
      
      for (let i = 0; i < count; i++){
        const rIdx = Math.floor(i / cols), cIdx = i % cols;
        const cx = Math.round(x + cIdx * gw + gw / 2 + randInt(-Math.min(12, gw * 0.2), Math.min(12, gw * 0.2)));
        const cy = Math.round(y + rIdx * gh + gh / 2 + randInt(-Math.min(12, gh * 0.2), Math.min(12, gh * 0.2)));
        circles.push({x: cx, y: cy, r: rr});
      }
      return circles;
    }

    /* ==========================================================
       æ–°ã—ã„ãƒ©ã‚¦ãƒ³ãƒ‰ã®ç”Ÿæˆ
       ========================================================== */
    function newRound(){
      roundLocked = false; // å…¥åŠ›ãƒ­ãƒƒã‚¯è§£é™¤
      round++;
      
      if (round > ROUNDS){ 
        endGame(); 
        return; 
      }

      // å·¦å³ã®å€‹æ•°ï¼ˆ1ï½10ï¼‰ã§ã€å¿…ãšä¸ç­‰ã«
      do {
        leftCount = randInt(MIN_COUNT, MAX_COUNT);
        rightCount = randInt(MIN_COUNT, MAX_COUNT);
      } while (leftCount === rightCount);

      // é ˜åŸŸåˆ†å‰²
      const halfW = Math.floor(W / dpr / 2);
      const fullH = Math.floor(H / dpr);
      const leftRect = {x: 0, y: 0, w: halfW, h: fullH};
      const rightRect = {x: halfW, y: 0, w: halfW, h: fullH};

      // å††ã®é…ç½®
      leftCircles = generateSide(leftRect, leftCount);
      rightCircles = generateSide(rightRect, rightCount);

      // UIæ›´æ–°
      roundDisplay.textContent = `Round: ${round}/${ROUNDS}`;
      qIndicator.textContent = `ãƒ©ã‚¦ãƒ³ãƒ‰ ${round}/${ROUNDS}`;
      draw();
    }

    /* ==========================================================
       UIåˆ¶å¾¡ï¼šãƒ‘ãƒãƒ«è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
       ========================================================== */
    function showTitle(){ 
      state = 'idle';
      resultPanel.classList.add('hidden'); 
      howPanel.classList.add('hidden'); 
      titlePanel.classList.remove('hidden'); 
      qIndicator.textContent = 'ã‚¿ãƒƒãƒ—ã§é–‹å§‹ã§ãã¾ã™';
      roundDisplay.textContent = 'Round: 0/10';
      scoreDisplay.textContent = 'Score: 0';
      draw();
    }

    function showHow(){ 
      titlePanel.classList.add('hidden'); 
      howPanel.classList.remove('hidden'); 
    }

    function showResult(finalScore){ 
      titlePanel.classList.add('hidden'); 
      howPanel.classList.add('hidden'); 
      resultPanel.classList.remove('hidden');
      
      // ãƒ™ã‚¹ãƒˆè¨˜éŒ²ã®æ›´æ–°åˆ¤å®š
      let updated = false;
      if (finalScore > best){
        best = finalScore;
        localStorage.setItem('cmp_best', String(best));
        updateBestPill();
        updated = true;
      }
      
      resultText.textContent = `æ­£ç­”æ•°ï¼š${finalScore} / ${ROUNDS}`;
      bestText.textContent = updated ? 'ğŸ‰ ãƒ™ã‚¹ãƒˆè¨˜éŒ²ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼' : `ãƒ™ã‚¹ãƒˆï¼š${best}/${ROUNDS}`;
    }

    /* ==========================================================
       ãƒˆãƒ¼ã‚¹ãƒˆã¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤æ©Ÿèƒ½
       ========================================================== */
    function showToast(ok){
      toast.classList.remove('show'); 
      void toast.offsetHeight;
      toast.classList.add('show');
      toast.children[0].style.display = ok ? 'block' : 'none';
      toast.children[1].style.display = ok ? 'none' : 'block';
      setTimeout(() => toast.classList.remove('show'), 650);
    }

    function showOverlay(text){ 
      overlayText.textContent = text; 
      overlay.classList.add('show'); 
    }

    function hideOverlay(){ 
      overlay.classList.remove('show'); 
    }

    /* ==========================================================
       ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³æ©Ÿèƒ½ï¼ˆ3,2,1,STARTï¼‰
       ========================================================== */
    function countdown3(onDone){
      showOverlay('3'); sfxTick();
      setTimeout(() => { showOverlay('2'); sfxTick(); }, 1000);
      setTimeout(() => { showOverlay('1'); sfxTick(); }, 2000);
      setTimeout(() => { showOverlay('START'); sfxGo(); setTimeout(hideOverlay, 350); onDone(); }, 3000);
    }

    /* ==========================================================
       ã‚²ãƒ¼ãƒ åˆ¶å¾¡
       ========================================================== */
    function startGame(){
      ensureAudio(); sfxTap();
      state = 'playing'; 
      round = 0; 
      score = 0; 
      roundLocked = false;
      scoreDisplay.textContent = score;
      titlePanel.classList.add('hidden');
      howPanel.classList.add('hidden');
      resultPanel.classList.add('hidden');
      qIndicator.textContent = 'ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ä¸­';
      countdown3(() => { newRound(); });
    }

    function endGame(){
      state = 'ended';
      const finalScore = Math.min(score, ROUNDS);
      qIndicator.textContent = 'çµæœ';
      showResult(finalScore);
    }

    /* ==========================================================
       Canvasæç”»
       ========================================================== */
    function draw(){
      const w = Math.floor(W / dpr);
      const h = Math.floor(H / dpr);
      ctx.clearRect(0, 0, w, h);

      // èƒŒæ™¯
      ctx.fillStyle = '#0f1220';
      ctx.fillRect(0, 0, w, h);

      // ä¸­å¤®ã®ä»•åˆ‡ã‚Š
      ctx.strokeStyle = 'rgba(255,255,255,.12)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(w / 2, 0); 
      ctx.lineTo(w / 2, h);
      ctx.stroke();

      if (state === 'playing'){
        // å·¦å³ã®å††ã‚’æç”»
        drawCircles(leftCircles, '#60a5fa');  // é’è‰²
        drawCircles(rightCircles, '#f59e0b'); // ã‚ªãƒ¬ãƒ³ã‚¸è‰²

        // ãƒ©ãƒ™ãƒ«
        ctx.font = '600 14px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
        ctx.textAlign = 'center'; 
        ctx.textBaseline = 'top';
        ctx.fillStyle = 'rgba(255,255,255,.6)';
        ctx.fillText(`å·¦: ${leftCount}`, w * 0.25, 8);
        ctx.fillText(`å³: ${rightCount}`, w * 0.75, 8);
      } else {
        // å¾…æ©ŸçŠ¶æ…‹ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
        ctx.fillStyle = 'rgba(0,0,0,.3)';
        ctx.fillRect(0, 0, w, h);
        ctx.fillStyle = '#eef2ff';
        ctx.font = '800 24px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('ã‚¿ãƒƒãƒ—ã§é–‹å§‹', w / 2, h / 2);
      }
    }

    function drawCircles(list, color){
      // ã»ã‚“ã®ã‚Šç«‹ä½“æ„Ÿã®ã‚ã‚‹ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      const g = ctx.createLinearGradient(0, 0, 0, H / dpr);
      g.addColorStop(0, color);
      g.addColorStop(1, shade(color, -0.2));
      ctx.fillStyle = g;
      
      list.forEach(c => {
        ctx.beginPath();
        ctx.arc(c.x, c.y, c.r, 0, Math.PI * 2);
        ctx.fill();
        // ã‚¨ãƒƒã‚¸
        ctx.strokeStyle = 'rgba(255,255,255,.1)';
        ctx.lineWidth = 1;
        ctx.stroke();
      });
    }

    function shade(hex, p){
      // hex like #RRGGBB, p in [-1,1]
      const n = parseInt(hex.slice(1), 16);
      let r = (n >> 16) & 255, g = (n >> 8) & 255, b = n & 255;
      r = Math.round(r + (p < 0 ? r * p : (255 - r) * p));
      g = Math.round(g + (p < 0 ? g * p : (255 - g) * p));
      b = Math.round(b + (p < 0 ? b * p : (255 - b) * p));
      return `rgb(${r},${g},${b})`;
    }

    /* ==========================================================
       ã‚¿ãƒƒãƒ/ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ï¼šç”»é¢ã®ã©ã¡ã‚‰å´ãŒã‚¿ãƒƒãƒ—ã•ã‚ŒãŸã‹ã‚’åˆ¤å®š
       ========================================================== */
    function handlePick(clientX){
      if (state !== 'playing') { 
        startGame(); 
        return; 
      }
      if (roundLocked) return; // å¤šé‡å…¥åŠ›é˜²æ­¢
      
      ensureAudio(); sfxTap();
      roundLocked = true;

      const rect = canvas.getBoundingClientRect();
      const x = clientX - rect.left;
      const pickLeft = x < rect.width / 2;
      const correct = (leftCount > rightCount && pickLeft) || (rightCount > leftCount && !pickLeft);

      // é¸æŠã—ãŸå´ã«ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º
      flashSide(pickLeft, correct);
      
      if (correct){
        sfxOk();
        score++; 
        scoreDisplay.textContent = `Score: ${score}`;
        showToast(true);
      } else {
        sfxNg();
        showToast(false);
      }
      
      // å°‘ã—å¾…ã£ã¦ã‹ã‚‰æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¸
      setTimeout(() => {
        if (state === 'playing') newRound();
      }, 680);
    }

    /* ==========================================================
       ã‚µã‚¤ãƒ‰é¸æŠæ™‚ã®ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
       ========================================================== */
    function flashSide(isLeft, ok){
      const w = Math.floor(W / dpr);
      const h = Math.floor(H / dpr);
      const x1 = isLeft ? 0 : w / 2;
      const x2 = isLeft ? w / 2 : w;
      
      ctx.save();
      ctx.globalAlpha = 0.35;
      ctx.fillStyle = ok ? '#22c55e' : '#ef4444';
      ctx.fillRect(x1, 0, x2 - x1, h);
      ctx.restore();
    }

    /* ==========================================================
       ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²ï¼šã‚¿ãƒƒãƒ/ã‚¯ãƒªãƒƒã‚¯å¯¾å¿œ
       ========================================================== */
    function setupPointer(){
      const usePointer = 'onpointerup' in window;
      
      if (usePointer){
        canvas.addEventListener('pointerup', (e) => { 
          e.preventDefault(); 
          handlePick(e.clientX); 
        }, {passive: false});
      } else {
        canvas.addEventListener('click', (e) => handlePick(e.clientX));
      }
    }

    function registerTap(el, handler){
      let used = false; 
      const wrap = (e) => { 
        if (used) return; 
        used = true; 
        handler(e); 
        setTimeout(() => { used = false; }, 0); 
      };
      el.addEventListener('pointerup', wrap, {passive: true});
      el.addEventListener('click', wrap, {passive: true});
    }

    /* ==========================================================
       åˆæœŸåŒ–ã¨ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
       ========================================================== */
    function init(){
      // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã®ç™»éŒ²
      registerTap(startBtn, startGame);
      if (startBtn2) registerTap(startBtn2, startGame);
      registerTap(howBtn, () => { ensureAudio(); sfxTap(); showHow(); });
      registerTap(backBtn, () => { ensureAudio(); sfxTap(); showTitle(); });
      registerTap(retryBtn, startGame);
      registerTap(toTitleBtn, () => { ensureAudio(); sfxTap(); showTitle(); });

      // Canvas ã®ãƒã‚¤ãƒ³ã‚¿ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
      setupPointer();
      
      // Canvas ã®ã‚µã‚¤ã‚ºèª¿æ•´
      resizeCanvas();
      
      // åˆæœŸç”»é¢è¡¨ç¤º
      showTitle();
    }

    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
    init();

  })();
  </script>
</body>
</html>